var DEBUG_MODE = false;
var timeout = 100;
var clientSock;

var myLog = Function.prototype.bind.call(console.log, console);
function debugLog() {
  if (DEBUG_MODE) {
    var args = Array.prototype.slice.call(arguments, 0);
    myLog.apply(console, args);
  }
}


chrome.app.runtime.onRestarted.addListener(function(data) {
  console.log("We restarted");
});

chrome.runtime.onStartup.addListener(function(details) {
  console.log("onStartup ", details);
});

chrome.runtime.onInstalled.addListener(function(details) {
  console.log("Installed", details);
});

chrome.runtime.onSuspend.addListener(function() {
  chrome.storage.local.set({lastUsedSocket:null});
});

chrome.runtime.onMessageExternal.addListener(function(msg, sender, responder) {
// TODO:  Bootloader type stufff
/*
   var device = new pinoccio.Device(port);
   device.connect(portName, function() {
     device.signOn(function() {
       console.log("DONE READ");
       return;
     });
   });
 */
var cmds = {
  program:function() {
    pinoccio.findSerial(function(err, device) {
      if (err) {
        console.error(err);
        return;
      }
      device.saveProgram(testProgram, function() {
        console.log("Save done");
      });
    });
  },
  detect:function() {
    if (!msg.timeout) {
      return responder({error:"A timeout must be specified when searching for the device."});
    }
    pinoccio.checkForDevice(msg.timeout, function(err, foundIt) {
      var resp = {
        found:foundIt === true ? true : false
      };
      if (err) resp.error = err;
      pinoccio.findSerial(function(err, device) {
        if (!err && device) {
          resp.isOn = true;
          resp.version = "1.0"; // We assume this for now until pinoccio.js allos other versions
        } else {
          resp.isOn = false;
        }
        responder(resp);
      });
    });
  },
  close:function() {
  },
  bitlash:function() {
    // TODO:  Support timeout
    pinoccio.findSerial(function(err, device) {
      if (err) {
        console.error(err);
        return;
      }

      if (!device) {
        console.error("Can't find the pinoccio");
        return;
      }

      console.log("We got it!");
      var conn = device.conn;

        console.log("Going to run %s", msg.command.trim());
        conn.unechoWrite(msg.command.trim() + "\n", function() {
          // TODO Make this multiline aware
          conn.readUntilPrompt("\n>", function(err, data) {
            var resp = {};
            if (err) {
              resp.error = err;
            } else {
              resp.result = data;
            }
            console.log("Result line is: ", resp);
            responder(resp);
          });
        });
    });
  }
};

if (!cmds.hasOwnProperty(msg.op)) {
  return responder({error:"Unknown op"});
}

cmds[msg.op]();

return true; // required if we want to respond after the listener
});

chrome.app.runtime.onLaunched.addListener(function(data) {
  console.log("We launched");

  var a = document.createElement('a');
  a.href = "http://hq.pinocc.io";
  a.target='_blank';
  a.click();
});


var testProgram = 
":100000000C94E4000C9405010C9405010C9405017A\n" + 
":100010000C9405010C9405010C9405010C94050148\n" + 
":100020000C9405010C9405010C9405010C94050138\n" +
":100030000C9405010C9405010C9405010C94050128\n" + 
":100040000C9405010C9405010C9405010C94050118\n" +
":100050000C9405010C9405010C9405010C942601E7\n" +
":100060000C9405010C9405010C9405010C940501F8\n" +
":100070000C9405010C9405010C9405010C940501E8\n" +
":100080000C9405010C9405010C9405010C940501D8\n" +
":100090000C9405010C9405010C9405010C940501C8\n" +
":1000A0000C9405010C9405010C9405010C940501B8\n" +
":1000B0000C9405010C9405010C9405010C940501A8\n" +
":1000C0000C9405010C9405010C9405010C94050198\n" +
":1000D0000C9405010C9405010C9405010C94050188\n" +
":1000E0000C9405010C9405010C9405010C94050178\n" +
":1000F0000C9405010C9405010C9405010C94050168\n" +
":100100000C9405010C9405010C9405010C94050157\n" +
":100110000C9405010C9405010C9405010C94050147\n" +
":100120000C9405010C9405010C9405010C94050137\n" +
":100130000C94050100000108090A000000000000FD\n" +
":100140000000000000000000000F1011000000007F\n" +
":100150000000000001028008102004402001040873\n" +
":1001600002040801021080408010204001020408AF\n" +
":100170001020408005050205050505050402020260\n" +
":10018000020404040404050404020202060606062E\n" +
":100190000606060600000000250000002B002E00C9\n" +
":1001A00031003400000000000000000000000000EA\n" +
":1001B0000000240000002A002D0030003300000061\n" +
":1001C000000000000000000011241FBECFEFD1E8A6\n" +
":1001D000DEBFCDBF00E00CBF12E0A0E0B2E0E8E17E\n" +
":1001E000F6E000E00BBF02C007900D92A230B1070D\n" +
":1001F000D9F712E0A2E0B2E001C01D92AB30B10726\n" +
":10020000E1F70E94FD020C940A030C94000061E0E7\n" +
":10021000809100020C948E02CF93DF93C0E0D2E075\n" +
":1002200061E088810E94C60268EE73E080E090E0A1\n" +
":100230000E949A0160E088810E94C60268EE73E025\n" +
":1002400080E090E0DF91CF910C949A011F920F9281\n" +
":100250000FB60F9211242F933F938F939F93AF93D9\n" +
":10026000BF938091020290910302A0910402B09189\n" +
":10027000050230910A02232F2D5F2D3720F40196BD\n" +
":10028000A11DB11D05C0232F2A570296A11DB11D26\n" +
":1002900020930A028093020290930302A093040227\n" +
":1002A000B09305028091060290910702A091080286\n" +
":1002B000B09109020196A11DB11D80930602909391\n" +
":1002C0000702A0930802B0930902BF91AF919F91DA\n" +
":1002D0008F913F912F910F900FBE0F901F90189507\n" +
":1002E0000F931F939FB7F894009106021091070295\n" +
":1002F000209108023091090286B5A89B06C08F3F65\n" +
":1003000021F00F5F1F4F2F4F3F4F9FBF322F212FE5\n" +
":10031000102F0027080F111D211D311D42E0000F75\n" +
":10032000111F221F331F4A95D1F7B801C9011F9130\n" +
":100330000F910895CF92DF92EF92FF92CF93DF93C8\n" +
":100340006B017C010E947001EB010EC00E947001E4\n" +
":100350006C1B7D0B683E734038F081E0C81AD108F1\n" +
":10036000E108F108C851DC4FC114D104E104F104E3\n" +
":1003700069F7DF91CF91FF90EF90DF90CF900895D4\n" +
":10038000789484B5826084BD84B5816084BD85B570\n" +
":10039000826085BD85B5816085BDEEE6F0E0808137\n" +
":1003A00081608083E1E8F0E0108280818260808358\n" +
":1003B000808181608083E0E8F0E0808181608083DB\n" +
":1003C000E1EBF0E0808184608083E0EBF0E080810D\n" +
":1003D00081608083E1E9F0E08081826080838081B8\n" +
":1003E00081608083E0E9F0E0808181608083E1EAE0\n" +
":1003F000F0E0808182608083808181608083E0EA98\n" +
":10040000F0E0808181608083E1E2F1E080818260C0\n" +
":100410008083808181608083E0E2F1E0808181607F\n" +
":100420008083EAE7F0E0808184608083808182605D\n" +
":100430008083808181608083808180688083109246\n" +
":10044000C1000895893009F443C088F4843029F14B\n" +
":1004500038F4823059F1E8F4813009F05EC023C0ED\n" +
":10046000873061F188F5863009F057C023C08D30A0\n" +
":1004700009F440C020F48B30A9F1C0F52DC08031C3\n" +
":1004800009F442C0813109F443C08F3009F045C0FE\n" +
":1004900037C0809180008F7703C0809180008F7D6E\n" +
":1004A00080938000089584B58F7702C084B58F7DD6\n" +
":1004B00084BD08958091B0008F7703C08091B00013\n" +
":1004C0008F7D8093B0000895809190008F7707C052\n" +
":1004D000809190008F7D03C080919000877F8093F2\n" +
":1004E000900008958091A0008F7707C08091A000B0\n" +
":1004F0008F7D03C08091A000877F8093A000089526\n" +
":10050000809120018F7707C0809120018F7D03C0EB\n" +
":1005100080912001877F809320010895CF93DF93FE\n" +
":1005200090E0FC01EC5AFE4F4491FC01EC58FE4F68\n" +
":100530008491882341F190E0880F991FFC01E255D6\n" +
":10054000FE4F25913491D9018C569E4FFC01859127\n" +
":100550009491C82FD92F9FB7F8948C91611106C040\n" +
":10056000409584238C938881842308C0623041F4B1\n" +
":10057000242F209582238C938881842B888302C02A\n" +
":10058000842B8C939FBFDF91CF9108950F931F937E\n" +
":10059000CF93DF931F92CDB7DEB7282F30E0F9015C\n" +
":1005A000EC5CFE4F8491F901EC5AFE4F1491F90175\n" +
":1005B000EC58FE4F04910023D1F0882321F0698389\n" +
":1005C0000E9422026981E02FF0E0EE0FFF1FEC563F\n" +
":1005D000FE4F85919491DC019FB7F8948C91611145\n" +
":1005E00003C01095812301C0812B8C939FBF0F9076\n" +
":1005F000DF91CF911F910F9108950E94C0010E9439\n" +
":100600000701C0E0D0E00E940C012097E1F30E94B6\n" +
":080610000000F9CFF894FFCFC0\n" +
":020618001700C9\n" +
":00000001FF\n";
